trigger:
  branches:
    include:
      - main

schedules:
  - cron: "30 8 * * 3"  # 8:30 UTC = 2:00 PM IST Wednesday
    displayName: Weekly Run - Wednesday 2PM IST
    branches:
      include:
        - main
    always: true

stages:
  - stage: SmokePreprod
    displayName: "Smoke - Preprod"
    jobs:
      - template: azure-pipelines/smoke-preprod.yml

  - stage: RegressionPreprod
    displayName: "Regression - Preprod"
    dependsOn: SmokePreprod
    condition: succeeded()
    jobs:
      - template: azure-pipelines/regression-preprod.yml

  - stage: SmokeProd
    displayName: "Smoke - Prod"
    dependsOn: RegressionPreprod
    condition: succeeded()
    jobs:
      - template: azure-pipelines/smoke-prod.yml

  - stage: RegressionProd
    displayName: "Regression - Prod"
    dependsOn: SmokeProd
    condition: succeeded()
    jobs:
      - template: azure-pipelines/regression-prod.yml

  - stage: Notify
    displayName: "Send Notifications"
    dependsOn: RegressionProd
    condition: always()
    jobs:
      - job: SlackEmail
        displayName: "Send Email and Slack Notification"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: echo "Sending Notifications..."
            displayName: "Notify Script"

          - task: SlackNotifier@1
            inputs:
              slackConnection: '<YourSlackServiceConnection>'
              messageType: 'Text'
              text: |
                *FE Automation Pipeline Notification*
                Smoke Preprod: ${{ dependencies.SmokePreprod.result }}
                Regression Preprod: ${{ dependencies.RegressionPreprod.result }}
                Smoke Prod: ${{ dependencies.SmokeProd.result }}
                Regression Prod: ${{ dependencies.RegressionProd.result }}
                Report: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)|Click here for pipeline summary>
              channelId: ''
              notifyOption: 'Always'
            condition: always()

          - task: Mail@2
            inputs:
              subject: 'FE Automation Pipeline - $(Build.BuildNumber)'
              body: |
                Pipeline: $(Build.DefinitionName)
                Status: ${{ dependencies.RegressionProd.result }}
                Build ID: $(Build.BuildId)
                Link: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)
              to: 'abhishek_matcha@vfc.com'
              cc: ''
              bcc: ''
              replyTo: 'noreply@example.com'
              from: 'abhishek_matcha@vfc.com'
            condition: always()